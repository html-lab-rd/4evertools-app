<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>


         <!-- Favicon -->
  <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/20b9de7f326dedf80fb4b5a26e56f7a4ffe824f4.png">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #df1783;
            --secondary: #8c318f;
            --accent: rgba(255,255,255,0.1);
            --light: #f8f9fa;
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
            --dark-text: #e2e8f0;
        }

        html.dark {
            --light: var(--dark-bg);
            --dark-text: #e2e8f0;
        }




        .custom-image-widget {
            position: fixed !important;
            top: 50px !important;
            margin: 0 !important;
            padding: 0 !important;
            right: 0px;
            z-index: 999;
        }
        
        .custom-image {
            width: 70px;
            height: auto;
            transition: transform 0.2s;
        }
        
        .custom-image-widget:hover .custom-image {
            transform: scale(1.2);
        }
        
        .custom-image-widget:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
                
        

        

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            min-height: 100vh;
            background-color: #eef2f7;
            color: #333;
        }

        html.dark body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: background 0.5s ease;
        }

        .nav-item {
            transition: all 0.3s;
        }

        .nav-item:hover {
            background-color: var(--accent);
        }

        .nav-item.active {
            background-color: var(--accent);
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html.dark .card {
            background: var(--dark-card);
        }

        input, select, textarea {
            background-color: #fbfbfb;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            color: #333;
            transition: all 0.2s;
        }
        html.dark input, html.dark select, html.dark textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: var(--dark-text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(223, 23, 131, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            padding: 10px 20px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-cancel {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .btn-cancel:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        html.dark .btn-cancel {
            background-color: #4b5563; /* gray-600 */
            color: var(--dark-text);
        }
        html.dark .btn-cancel:hover {
            background-color: #6b7280; /* gray-500 */
        }

        .bg-primary { background-color: var(--primary); }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
        }
        html.dark .calendar-grid { background-color: #4a5568; }

        .calendar-day, .calendar-header {
            background-color: white;
            padding: 8px;
        }
        html.dark .calendar-day, html.dark .calendar-header { background-color: var(--dark-card); }
        .calendar-header { font-weight: bold; text-align: center; }

        .calendar-day { min-height: 120px; }
        .calendar-day.other-month { background-color: #f1f5f9; }
        html.dark .calendar-day.other-month { background-color: #1a202c; color: #718096; }

        .calendar-task {
            background-color: #fecdd3;
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        html.dark .calendar-task { background-color: #b91c1c; color: white; }

        .calendar-note {
            background-color: #fef9c3; /* yellow-100 */
            color: #a16207; /* yellow-700 */
            border-left: 3px solid #f59e0b; /* yellow-500 */
        }
        html.dark .calendar-note { 
            background-color: #451a03; /* amber-950 */
            color: #fef08a; /* yellow-200 */
        }

        /* Modal Styles */
        #modal-container {
            transition: opacity 0.3s ease;
        }
        #modal-content {
            transition: transform 0.3s ease;
        }

        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .section-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 10px;
        }
        html.dark .section-footer {
            border-top-color: #4a5568;
            color: #a0aec0;
        }
        
        /* Kanban Styles */
        .kanban-task {
            cursor: grab;
        }
        .kanban-task.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .kanban-col.drag-over {
            background-color: var(--accent);
            border-radius: 0.5rem;
        }
        html.dark .kanban-col.drag-over {
             background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg flex h-screen">

   

    <!-- Sidebar -->
    <div class="sidebar w-64 flex-shrink-0 flex flex-col p-6">
        <div class="mb-10">
            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                <i data-lucide="zap" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Headquarters</h1>
            <p class="text-white/80 text-sm leading-relaxed">Your productivity command center.</p>
        </div>
        
        <nav class="flex-grow space-y-2">
            <div id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
            <div id="nav-tasks" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="tasks"><i data-lucide="check-square"></i><span>Tasks</span></div>
            <div id="nav-projects" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="projects"><i data-lucide="folder-kanban"></i><span>Projects</span></div>
            <div id="nav-notes" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="notes"><i data-lucide="notebook-pen"></i><span>Notes</span></div>
            <div id="nav-calendar" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="calendar"><i data-lucide="calendar-days"></i><span>Calendar</span></div>
            
            <!-- NEW IFRAME BUTTONS SECTION -->
            <!-- To add a new iframe link, copy the entire block from START to END -->
            <!-- Then, edit the data-iframe-url, data-iframe-title, the icon (data-lucide), and the button text -->
            
            <!-- START: Copy this block to add a new iframe link -->
            <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" 
                 data-view="iframe-view" 
                 data-iframe-url="https://bebell-digital-solutions.github.io/aiba-deepseek/en-v03" 
                 data-iframe-title="AI Assistant">
                <i data-lucide="bot"></i><span>AI Assistant</span>
            </div>
            <!-- END: Copy block -->




      <button id="theme-toggle" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="sun" class="w-5 h-5"></i><span>Light Mode</span>
            </button>

        </nav>

        <div class="space-y-3 mt-auto">
             <button id="settings-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="palette" class="w-5 h-5"></i><span>Customization</span>
            </button>
    
            <a href="https://www.notion.so/templates" target="_blank" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent">
                 <i data-lucide="download" class="w-5 h-5"></i><span>Notion Templates</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow p-8 overflow-y-auto">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section space-y-8">
            <div>
                <h1 class="text-4xl font-bold">Dashboard</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Here's your productivity summary for today.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-add-task" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> New Task
                </button>
                <button id="btn-add-note" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> Quick Note
                </button>
                <button id="btn-add-project" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> New Project
                </button>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                <!-- Stats will be rendered here by JS -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Task Completion Status</h2>
                    <div class="relative flex-grow min-h-[250px]">
                        <canvas id="task-completion-chart"></canvas>
                    </div>
                </div>
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">This Week's Reminders</h2>
                    <div id="weekly-deadlines" class="flex-grow overflow-y-auto max-h-[268px]">
                        <!-- Weekly deadlines will be rendered here by JS -->
                    </div>
                </div>
            </div>

            <div class="card p-6">
                 <h2 class="text-xl font-bold mb-4">Tasks Overview</h2>
                 <div id="dashboard-tasks" class="text-gray-600 dark:text-gray-300">Loading tasks...</div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">Calendar Preview</h2>
                <div id="dashboard-calendar-preview">Loading calendar...</div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Tasks</h1>
                <button id="add-task-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Task
                </button>
            </div>
            <div id="tasks-filter-container" class="card p-4 mb-6"></div>
            <div id="tasks-list" class="space-y-4"></div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Projects</h1>
                 <button id="add-project-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Project
                </button>
            </div>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Notes Section -->
        <section id="notes" class="section hidden">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Notes</h1>
                 <button id="add-note-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Note
                </button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section hidden space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-4xl font-bold">Calendar</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                         <button id="sync-google-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white text-sm py-2">
                             <i data-lucide="calendar-plus"></i> Sync with Google
                        </button>
                        <button id="download-ics-btn" class="btn bg-green-500 hover:bg-green-600 text-white text-sm py-2">
                            <i data-lucide="download-cloud"></i> Download .ICS
                        </button>
                    </div>
                    <div class="flex items-center rounded-lg p-1 bg-primary text-white">
                        <button id="calendar-view-month" class="px-3 py-1 text-sm rounded-md">Month</button>
                        <button id="calendar-view-week" class="px-3 py-1 text-sm rounded-md">Week</button>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">Today's Tasks</h2>
                <div id="calendar-today-tasks"></div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                     <button id="calendar-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-left"></i></button>
                     <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                     <button id="calendar-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendar-container"></div>
            </div>
        </section>
        
        <!-- IFrame Container Section -->
        <section id="iframe-view" class="section hidden h-full flex flex-col">
            <h1 id="iframe-title" class="text-4xl font-bold mb-6 flex-shrink-0"></h1>
            <div class="flex-grow rounded-xl overflow-hidden shadow-lg">
                <iframe id="content-iframe" class="w-full h-full border-0" src="about:blank"></iframe>
            </div>
        </section>

        <!-- Kanban View Section -->
        <section id="kanban-view" class="section hidden h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h1 class="text-4xl font-bold truncate pr-4">Kanban: <span id="kanban-project-title"></span></h1>
                <button id="back-to-projects-btn" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">
                    <i data-lucide="arrow-left"></i>
                    <span class="hidden sm:inline">Back to Projects</span>
                </button>
            </div>
            <div id="kanban-board" class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-x-auto">
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-red-500 flex-shrink-0">To Do</h2>
                    <div id="kanban-pending" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-yellow-500 flex-shrink-0">In Progress</h2>
                    <div id="kanban-progress" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-green-500 flex-shrink-0">Done</h2>
                    <div id="kanban-done" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <footer class="section-footer">
            <p>Developed with 💖 by <a href="https://bebelldigitalsolutions.com" target="_blank" rel="noopener noreferrer" class="hover:"><strong style="color:var(--primary);">Bebell Digital Solutions</strong></a></p>
            <p>Copyright © 2025 • All rights reserved</p>
        </footer>
    </main>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center p-4 opacity-0">
        <div id="modal-content" class="card w-full max-w-2xl transform -translate-y-10">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-600">
                <h2 id="modal-title" class="text-2xl font-bold">Modal Title</h2>
                <button id="modal-close" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <div class="save-notification" id="saveNotification">
        Data saved successfully!
    </div>





<script>(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://api.helpdesk.icu/widget/6cb4c417-1da5-31ec-ae0d-b1f79dad581f?r=' + encodeURIComponent(window.location);
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'contactus-jssdk'));</script>


    
    
    <script>
        (function() {
            'use strict';

            // --- STATE MANAGEMENT & GLOBALS ---
            const state = {
                tasks: [],
                projects: [],
                notes: [],
                activeView: 'dashboard',
                activeProjectId: null, // For Kanban view
                calendarDate: new Date(),
                calendarView: 'month', // 'month' or 'week'
                taskSearchQuery: '',
                activeTagFilter: null,
                primaryColor: '#df1783',
                secondaryColor: '#8c318f'
            };
            let taskCompletionChart = null;

            // --- DATABASE SERVICE ---
            const dbService = {
                db: null,
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('HeadquartersDB', 2);
                        request.onerror = e => reject('Error opening DB', e);
                        request.onsuccess = e => {
                            this.db = e.target.result;
                            resolve();
                        };
                        request.onupgradeneeded = e => {
                            const db = e.target.result;
                            const stores = ['tasks', 'projects', 'notes'];
                            stores.forEach(s => {
                                if (!db.objectStoreNames.contains(s)) {
                                    db.createObjectStore(s, { keyPath: 'id' });
                                }
                            });
                        };
                    });
                },
                async add(storeName, item) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error on ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.put(item).onerror = e => reject(`Error adding/updating in ${storeName}`, e.target.error);
                    });
                },
                async getAll(storeName) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readonly');
                        const store = tx.objectStore(storeName);
                        const req = store.getAll();
                        req.onsuccess = e => resolve(e.target.result);
                        req.onerror = e => reject(`Error getting all from ${storeName}`, e.target.error);
                    });
                },
                async delete(storeName, key) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error on ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.delete(key).onerror = e => reject(`Error deleting from ${storeName}`, e.target.error);
                    });
                },
            };

            // --- DOM SELECTORS ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            
            // --- UI & THEME FUNCTIONS ---
            function applyColors(primary, secondary) {
                const root = document.documentElement;
                state.primaryColor = primary;
                state.secondaryColor = secondary;
                root.style.setProperty('--primary', primary);
                root.style.setProperty('--secondary', secondary);
            }

            function saveColorsToStorage(primary, secondary) {
                localStorage.setItem('headquarters-colors', JSON.stringify({ primary, secondary }));
            }

            function loadColorsFromStorage() {
                const savedColors = localStorage.getItem('headquarters-colors');
                if (savedColors) {
                    const { primary, secondary } = JSON.parse(savedColors);
                    applyColors(primary, secondary);
                } else {
                    // Apply default colors if none are saved
                    applyColors(state.primaryColor, state.secondaryColor);
                }
            }


            // --- RENDER FUNCTIONS & HELPERS ---
            function getPriorityInfo(priority) {
                switch (priority) {
                    case 'p1': return { icon: 'chevrons-up', text: 'Highest', badge: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' };
                    case 'p2': return { icon: 'chevron-up', text: 'High', badge: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300' };
                    case 'p3': return { icon: 'equal', text: 'Medium', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                    case 'p4': return { icon: 'chevron-down', text: 'Low', badge: 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300' };
                    default: return { icon: 'equal', text: 'Medium', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                }
            }

            function getStatusInfo(status) {
                switch (status) {
                    case 'progress': return { text: 'In Progress', badge: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' };
                    case 'done': return { text: 'Done', badge: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' };
                    case 'pending':
                    default: return { text: 'To Do', badge: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                }
            }

            function getAllCalendarEvents() {
                const taskEvents = state.tasks.filter(t => t.dueDate).map(t => ({...t, type: 'task'}));
                const noteEvents = state.notes.filter(n => n.dueDate).map(n => ({...n, type: 'note'}));
                return [...taskEvents, ...noteEvents];
            }

            function render() {
                $$('.section').forEach(el => el.classList.add('hidden'));
                const activeSection = $(`#${state.activeView}`);
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                }

                switch(state.activeView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'tasks': renderTasks(); break;
                    case 'projects': renderProjects(); break;
                    case 'notes': renderNotes(); break;
                    case 'calendar': renderCalendar(); break;
                    case 'kanban-view':
                        if (state.activeProjectId) renderKanbanView(state.activeProjectId);
                        break;
                    // No case needed for 'iframe-view' as its setup is handled in handleNavClick
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            function renderDashboard() {
                // Render Stats
                const statsContainer = $('#dashboard-stats');
                const pendingTasksCount = state.tasks.filter(t => !t.completed).length;
                const activeProjects = state.projects.length; 
                const totalNotes = state.notes.length;

                statsContainer.innerHTML = `
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full"><i data-lucide="list-checks" class="text-blue-500"></i></div>
                        <div><div class="text-2xl font-bold">${pendingTasksCount}</div><div class="text-gray-500 dark:text-gray-400">Pending Tasks</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full"><i data-lucide="folder-kanban" class="text-purple-500"></i></div>
                        <div><div class="text-2xl font-bold">${activeProjects}</div><div class="text-gray-500 dark:text-gray-400">Active Projects</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full"><i data-lucide="notebook-pen" class="text-yellow-500"></i></div>
                        <div><div class="text-2xl font-bold">${totalNotes}</div><div class="text-gray-500 dark:text-gray-400">Total Notes</div></div>
                    </div>
                `;

                // Render Doughnut Chart
                const completedTasks = state.tasks.filter(t => t.completed).length;
                const pendingChartTasks = state.tasks.length - completedTasks;
                const totalTasks = state.tasks.length;
                
                if (taskCompletionChart) {
                    taskCompletionChart.destroy();
                }
                
                const chartCtx = $('#task-completion-chart').getContext('2d');
                
                const chartData = {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completedTasks, pendingChartTasks],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        borderWidth: 4
                    }]
                };

                const chartOptions = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom', 
                            labels: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#333', padding: 20 }
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    cutout: '70%'
                };

                if (totalTasks === 0) {
                    chartData.labels = ['No Tasks'];
                    chartData.datasets = [{
                        data: [1],
                        backgroundColor: [document.documentElement.classList.contains('dark') ? '#4a5568' : '#e5e7eb'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                        borderWidth: 4
                    }];
                    chartOptions.plugins.tooltip.enabled = false;
                    chartOptions.plugins.legend.display = false;
                }
                
                taskCompletionChart = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: chartData,
                    options: chartOptions
                });

                // Render Weekly Deadlines
                const weeklyDeadlinesContainer = $('#weekly-deadlines');
                if (weeklyDeadlinesContainer) {
                    const todayForWeek = new Date();
                    // Set to Sunday of the current week
                    const startOfWeek = new Date(todayForWeek.setDate(todayForWeek.getDate() - todayForWeek.getDay()));
                    startOfWeek.setHours(0, 0, 0, 0);

                    // Set to Saturday of the current week
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);

                    const thisWeeksTasks = state.tasks
                        .filter(t => 
                            !t.completed &&
                            t.dueDate &&
                            new Date(t.dueDate) >= startOfWeek &&
                            new Date(t.dueDate) <= endOfWeek
                        )
                        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                    
                    const priorityIcons = { p1: '🔥', p2: '⚠️', p3: '🔵', p4: '⬇️' };

                    const header = `
                        <div class="grid grid-cols-[50px_60px_1fr_40px] gap-4 px-2 pb-2 border-b border-gray-300 dark:border-gray-600">
                            <span class="font-bold text-xs uppercase text-gray-400">Day</span>
                            <span class="font-bold text-xs uppercase text-gray-400">Date</span>
                            <span class="font-bold text-xs uppercase text-gray-400">Task</span>
                            <span class="font-bold text-xs uppercase text-gray-400 text-center">🔔</span>
                        </div>
                    `;

                    let content;
                    if (thisWeeksTasks.length > 0) {
                        const body = thisWeeksTasks.map((task) => {
                            const dueDate = new Date(task.dueDate);
                            const day = dueDate.toLocaleDateString('en-US', { weekday: 'short' });
                            const date = dueDate.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit' });
                            const priorityInfo = getPriorityInfo(task.priority);
                            const icon = priorityIcons[task.priority] || '🔵';
                            return `
                                <div class="grid grid-cols-[50px_60px_1fr_40px] gap-4 items-center py-2 px-2 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                    <span class="font-semibold text-sm capitalize">${day.replace('.', '')}</span>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">${date}</span>
                                    <span class="text-sm truncate" title="${task.title}">${task.title}</span>
                                    <span class="text-center text-lg" title="Priority: ${priorityInfo.text}">${icon}</span>
                                </div>
                            `;
                        }).join('');

                        content = `<div class="mt-2">${body}</div>`;
                    } else {
                        content = `
                        <div class="flex flex-col items-center justify-center text-center py-8">
                            <i data-lucide="zap" class="w-16 h-16 text-gray-300 dark:text-gray-600 mb-4"></i>
                            <p class="text-gray-500">No deadlines this week!</p>
                        </div>`;
                    }
                    weeklyDeadlinesContainer.innerHTML = header + content;
                }


                // Render Task Overview, sorted by priority
                const taskOverview = $('#dashboard-tasks');
                const incompleteTasks = state.tasks
                    .filter(t => !t.completed)
                    .sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));
                
                if (incompleteTasks.length > 0) {
                    taskOverview.innerHTML = incompleteTasks
                        .slice(0, 5)
                        .map(t => {
                            const priorityInfo = getPriorityInfo(t.priority);
                            return `
                                <div class="py-3 border-b dark:border-gray-700 flex justify-between items-center">
                                    <span>${t.title}</span>
                                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                        <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                        ${priorityInfo.text}
                                    </span>
                                </div>`;
                        })
                        .join('');
                } else {
                    taskOverview.innerHTML = '<p class="text-gray-500">No pending tasks. Great job!</p>';
                }

                // Render Calendar Preview
                const calendarPreview = $('#dashboard-calendar-preview');
                const allEvents = getAllCalendarEvents();
                const upcomingEvents = allEvents
                    .filter(e => (!e.completed) && new Date(e.dueDate) >= new Date())
                    .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
                    .slice(0, 3);
                if (upcomingEvents.length > 0) {
                    calendarPreview.innerHTML = upcomingEvents
                        .map(e => `<div class="py-2 border-b dark:border-gray-700">${e.type === 'note' ? '🔔' : '🗓️'} ${e.title} - <span class="text-sm text-gray-500">${new Date(e.dueDate).toLocaleDateString('en-US')}</span></div>`)
                        .join('');
                } else {
                    calendarPreview.innerHTML = '<p class="text-gray-500">No upcoming deadlines or reminders.</p>';
                }
            }

            function renderTasks() {
                const list = $('#tasks-list');
                const filterContainer = $('#tasks-filter-container');

                // Render filter controls
                const allTags = [...new Set(state.tasks.flatMap(t => t.tags || []))].sort();
                filterContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-grow">
                            <label for="task-search-input" class="sr-only">Search Tasks</label>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                <input id="task-search-input" type="search" placeholder="Search tasks by title..." class="w-full p-2 pl-10 rounded-lg" value="${state.taskSearchQuery || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 flex-wrap">
                        <span class="font-semibold text-sm">Filter by Tag:</span>
                        ${allTags.length > 0 ? allTags.map(tag => `<button class="tag-filter-btn px-3 py-1 text-sm rounded-full ${state.activeTagFilter === tag ? 'btn-primary' : 'bg-gray-500 text-white dark:bg-gray-600'}" data-tag="${tag}">${tag}</button>`).join('') : '<span class="text-sm text-gray-500">No tags yet.</span>'}
                        ${state.activeTagFilter ? `<button id="clear-tag-filter-btn" class="text-sm text-red-500 hover:underline">Clear Filter</button>` : ''}
                    </div>
                `;

                // Filter tasks logic
                let filteredTasks = [...state.tasks];
                if (state.taskSearchQuery) {
                    const query = state.taskSearchQuery.toLowerCase();
                    filteredTasks = filteredTasks.filter(t => t.title.toLowerCase().includes(query) || (t.description && t.description.toLowerCase().includes(query)));
                }
                if (state.activeTagFilter) {
                    filteredTasks = filteredTasks.filter(t => t.tags && t.tags.includes(state.activeTagFilter));
                }
                
                const sortedTasks = filteredTasks.sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));

                if(sortedTasks.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500">No tasks match your criteria.</div>`;
                    return;
                }
                list.innerHTML = sortedTasks.map(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const statusInfo = getStatusInfo(task.status);
                    const project = task.projectId ? state.projects.find(p=>p.id === task.projectId) : null;
                    return `
                    <div class="card p-4 flex items-start gap-4" data-task-id="${task.id}">
                        <button class="task-complete-btn mt-1 flex-shrink-0">
                            <i data-lucide="${task.completed ? 'check-circle-2' : 'circle'}" class="w-6 h-6 ${task.completed ? 'text-green-500' : 'text-gray-400'}"></i>
                        </button>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="font-bold text-lg ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</h3>
                                <div class="flex items-center flex-shrink-0 gap-2">
                                     <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusInfo.badge}">${statusInfo.text}</span>
                                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                        <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                        ${priorityInfo.text}
                                    </span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${task.description || ''}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-500 mt-3 flex-wrap">
                                ${task.dueDate ? `<div class="flex items-center gap-1.5"><i data-lucide="calendar" class="w-4 h-4"></i> ${new Date(task.dueDate).toLocaleDateString('en-US')}</div>` : ''}
                                ${project ? `<div class="flex items-center gap-1.5"><i data-lucide="folder-kanban" class="w-4 h-4"></i> ${project.name}</div>` : ''}
                                ${task.urgency ? `<div class="flex items-center gap-1.5 text-red-600"><i data-lucide="clock" class="w-4 h-4"></i> Urgent</div>` : ''}
                                ${task.importance ? `<div class="flex items-center gap-1.5 text-yellow-600"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Important</div>` : ''}
                            </div>
                             ${task.tags && task.tags.length > 0 ? `<div class="mt-3 flex flex-wrap gap-2">${task.tags.map(tag => `<span class="bg-primary text-white text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="flex-shrink-0 flex gap-1">
                            <button class="task-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="task-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>`
                }).join('');
            }

            function renderProjects() {
                const list = $('#projects-list');
                if(state.projects.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No projects yet. Add one to get started!</div>`;
                    return;
                }
                list.innerHTML = state.projects.map(p => `
                    <div class="card p-6 flex flex-col" data-project-id="${p.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2 text-primary">${p.name}</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">${p.description || 'No description.'}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                             <button class="project-kanban-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="View Kanban">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                            </button>
                            <button class="project-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Edit Project">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button class="project-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Delete Project">
                                <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderNotes() {
                const list = $('#notes-list');
                if(state.notes.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No notes yet. Add one to get started!</div>`;
                    return;
                }
                list.innerHTML = state.notes.map(n => `
                    <div class="card p-6 flex flex-col" data-note-id="${n.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2">${n.title}</h3>
                            <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap text-sm">${n.content || ''}</p>
                            ${n.dueDate ? `
                            <div class="mt-3 pt-2 border-t dark:border-gray-600 text-sm text-yellow-600 dark:text-yellow-400 flex items-center gap-1.5">
                                <i data-lucide="bell" class="w-4 h-4"></i>
                                <span>Reminder: ${new Date(n.dueDate).toLocaleDateString('en-US')}</span>
                            </div>` : ''}
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                            <button class="note-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="note-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function renderKanbanView(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) {
                    state.activeView = 'projects';
                    render();
                    return;
                }

                $('#kanban-project-title').textContent = project.name;

                const projectTasks = state.tasks.filter(t => t.projectId === projectId);
                const pendingCol = $('#kanban-pending');
                const progressCol = $('#kanban-progress');
                const doneCol = $('#kanban-done');

                // Clear columns before rendering
                pendingCol.innerHTML = '';
                progressCol.innerHTML = '';
                doneCol.innerHTML = '';

                projectTasks.forEach(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const taskCardHtml = `
                        <div class="kanban-task card p-3" draggable="true" data-task-id="${task.id}">
                            <h4 class="font-bold mb-1">${task.title}</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${task.description || ''}</p>
                            <div class="flex justify-between items-center">
                                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                    <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                    ${priorityInfo.text}
                                </span>
                            </div>
                        </div>`;
                    switch (task.status) {
                        case 'progress':
                            progressCol.innerHTML += taskCardHtml;
                            break;
                        case 'done':
                            doneCol.innerHTML += taskCardHtml;
                            break;
                        case 'pending':
                        default:
                            pendingCol.innerHTML += taskCardHtml;
                            break;
                    }
                });

                if (window.lucide) {
                    lucide.createIcons();
                }
                setupKanbanEventListeners(projectId);
            }

            function updateCalendarViewToggle() {
                const monthBtn = $('#calendar-view-month');
                const weekBtn = $('#calendar-view-week');
                const activeClasses = ['bg-black/20', 'shadow-inner'];

                // Reset classes on both buttons first
                monthBtn.classList.remove(...activeClasses);
                weekBtn.classList.remove(...activeClasses);

                // Apply active classes to the correct button
                if (state.calendarView === 'month') {
                    monthBtn.classList.add(...activeClasses);
                } else {
                    weekBtn.classList.add(...activeClasses);
                }
            }

            function renderMonthlyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = state.calendarDate;
                calTitle.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const month = date.getMonth();
                const year = date.getFullYear();

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDayOfMonth.getDay();
                
                const allEvents = getAllCalendarEvents();

                let gridHtml = '<div class="calendar-grid">';
                'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < startingDay; i++) {
                    gridHtml += '<div class="calendar-day other-month"></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(year, month, i);
                    dayDate.setHours(0, 0, 0, 0);
                    const eventsOnDay = allEvents.filter(e => {
                        if (!e.dueDate) return false;
                        const eventDate = new Date(e.dueDate);
                        eventDate.setHours(0, 0, 0, 0);
                        return eventDate.getTime() === dayDate.getTime();
                    });

                    let eventsHtml = eventsOnDay.map(e => {
                        const className = e.type === 'task' ? 'calendar-task' : 'calendar-note';
                        return `<div class="${className} text-xs p-1 my-1 rounded-md truncate" title="${e.title}">${e.title}</div>`;
                    }).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${i}</div>
                        ${eventsHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderWeeklyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = new Date(state.calendarDate);

                // Find Sunday of the current week
                const firstDayOfWeek = new Date(date);
                firstDayOfWeek.setDate(date.getDate() - date.getDay());
                
                // Find Saturday of the current week
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                const options = { month: 'long', day: 'numeric' };
                calTitle.textContent = `${firstDayOfWeek.toLocaleDateString('en-US', options)} - ${lastDayOfWeek.toLocaleDateString('en-US', { ...options, year: 'numeric' })}`;

                const allEvents = getAllCalendarEvents();

                let gridHtml = '<div class="calendar-grid">';
                'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(firstDayOfWeek);
                    currentDay.setDate(firstDayOfWeek.getDate() + i);
                    currentDay.setHours(0, 0, 0, 0);
                    
                    const eventsOnDay = allEvents.filter(e => {
                        if (!e.dueDate) return false;
                        const taskDate = new Date(e.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === currentDay.getTime();
                    });
                    
                    let eventsHtml = eventsOnDay.map(e => {
                        const className = e.type === 'task' ? 'calendar-task' : 'calendar-note';
                        return `<div class="${className} text-xs p-1 my-1 rounded-md truncate" title="${e.title}">${e.title}</div>`;
                    }).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${currentDay.getDate()}</div>
                        ${eventsHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderCalendar() {
                const todayTasksContainer = $('#calendar-today-tasks');
                
                updateCalendarViewToggle();
                if (state.calendarView === 'month') {
                    renderMonthlyCalendar();
                } else {
                    renderWeeklyCalendar();
                }

                // Render Today's Tasks (common for both views)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const allEvents = getAllCalendarEvents();
                const todaysEvents = allEvents.filter(e => {
                    if (!e.dueDate) return false;
                    const eventDate = new Date(e.dueDate);
                    eventDate.setHours(0, 0, 0, 0);
                    return eventDate.getTime() === today.getTime();
                });
                
                if (todaysEvents.length > 0) {
                    todayTasksContainer.innerHTML = todaysEvents.map(e => {
                        const isTask = e.type === 'task';
                        const bgColor = isTask 
                            ? (e.completed ? 'bg-green-100 dark:bg-green-900' : 'bg-blue-100 dark:bg-blue-900')
                            : 'bg-yellow-100 dark:bg-yellow-900';
                        return `<div class="p-2 rounded-md ${bgColor}">${e.title}</div>`;
                    }).join('<div class="my-2"></div>');
                } else {
                    todayTasksContainer.innerHTML = '<p class="text-gray-500">No tasks or reminders scheduled for today.</p>';
                }

                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            // --- MODAL & FORM LOGIC ---
            function openModal(title, content, setupCallback) {
                $('#modal-title').textContent = title;
                $('#modal-body').innerHTML = content;
                $('#modal-container').classList.remove('hidden');
                $('#modal-container').classList.add('flex');
                setTimeout(() => {
                    $('#modal-container').classList.remove('opacity-0');
                    $('#modal-content').classList.remove('-translate-y-10');
                }, 10);
                if (window.lucide) {
                    lucide.createIcons();
                }
                if (setupCallback) {
                    setupCallback();
                }
            }

            function closeModal() {
                $('#modal-content').classList.add('-translate-y-10');
                $('#modal-container').classList.add('opacity-0');
                setTimeout(() => {
                    $('#modal-container').classList.add('hidden');
                    $('#modal-container').classList.remove('flex');
                    $('#modal-body').innerHTML = ''; // Clear body to remove old listeners
                }, 300);
            }
            
            function showConfirmationModal(title, message, onConfirm) {
                const content = `
                    <p class="text-gray-600 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="modal-cancel-confirm" class="btn btn-cancel">Cancel</button>
                        <button id="modal-confirm" class="btn bg-red-500 text-white">Confirm</button>
                    </div>
                `;
                openModal(title, content, () => {
                    $('#modal-confirm').addEventListener('click', () => {
                        onConfirm();
                        closeModal();
                    });
                    $('#modal-cancel-confirm').addEventListener('click', () => {
                        closeModal();
                    });
                });
            }

            function getTaskFormHtml(task = {}) {
                const isNew = !task.id;
                const projectsOptions = state.projects.map(p => `<option value="${p.id}" ${task.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                return `
                    <form id="task-form" class="space-y-4" data-task-id="${task.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">Title</label>
                            <input name="title" required class="w-full p-2" value="${task.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Description</label>
                            <textarea name="description" class="w-full p-2" rows="3">${task.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">Due Date</label>
                                <input name="dueDate" type="date" class="w-full p-2" value="${task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Project</label>
                                <select name="projectId" class="w-full p-2">
                                    <option value="">None</option>
                                    ${projectsOptions}
                                </select>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">Priority</label>
                                <select name="priority" class="w-full p-2">
                                   <option value="p1" ${task.priority === 'p1' ? 'selected' : ''}>🔥 Highest</option>
                                   <option value="p2" ${task.priority === 'p2' ? 'selected' : ''}>⚠️ High</option>
                                   <option value="p3" ${!task.priority || task.priority === 'p3' ? 'selected':''}>🔵 Medium</option>
                                   <option value="p4" ${task.priority === 'p4' ? 'selected' : ''}>⬇️ Low</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Urgency</label>
                                <select name="urgency" class="w-full p-2">
                                   <option value="true" ${task.urgency ? 'selected' : ''}>⏰ Urgent</option>
                                   <option value="false" ${!task.urgency ? 'selected' : ''}>Not Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Importance</label>
                                <select name="importance" class="w-full p-2">
                                   <option value="true" ${task.importance ? 'selected' : ''}>⚠️ Important</option>
                                   <option value="false" ${!task.importance ? 'selected' : ''}>Not Important</option>
                                </select>
                            </div>
                        </div>
                         <div>
                            <label class="font-semibold block mb-1">Tags (comma separated)</label>
                            <input name="tags" class="w-full p-2" placeholder="e.g. work, personal, follow-up" value="${(task.tags || []).join(', ')}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Add Task' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
            }

            function getProjectFormHtml(project = {}) {
                const isNew = !project.id;
                 return `
                    <form id="project-form" class="space-y-4" data-project-id="${project.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">Project Name</label>
                            <input name="name" required class="w-full p-2" value="${project.name || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Description</label>
                            <textarea name="description" class="w-full p-2" rows="4">${project.description || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Add Project' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
            }

            function getNoteFormHtml(note = {}) {
                const isNew = !note.id;
                 return `
                    <form id="note-form" class="space-y-4" data-note-id="${note.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">Title</label>
                            <input name="title" required class="w-full p-2" value="${note.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Content</label>
                            <textarea name="content" class="w-full p-2" rows="8">${note.content || ''}</textarea>
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Reminder Date (Optional)</label>
                            <input name="dueDate" type="date" class="w-full p-2" value="${note.dueDate ? new Date(note.dueDate).toISOString().split('T')[0] : ''}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'Add Note' : 'Save Changes'}</button>
                        </div>
                    </form>
                `;
            }
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                let item, storeName;

                switch(form.id) {
                    case 'task-form':
                        storeName = 'tasks';
                        const taskId = form.dataset.taskId;
                        const existingTask = taskId ? state.tasks.find(t => t.id === taskId) : {};
                        const tagsRaw = formData.get('tags') || '';
                        item = {
                            ...existingTask,
                            id: taskId || `task_${Date.now()}`,
                            createdAt: taskId ? existingTask.createdAt : Date.now(),
                            completed: existingTask.completed || false,
                            status: existingTask.status || 'pending',
                            title: formData.get('title'),
                            description: formData.get('description'),
                            dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null,
                            projectId: formData.get('projectId'),
                            priority: formData.get('priority'),
                            urgency: formData.get('urgency') === 'true',
                            importance: formData.get('importance') === 'true',
                            tags: tagsRaw.split(',').map(t => t.trim()).filter(t => t),
                        };
                        break;
                    case 'project-form':
                        storeName = 'projects';
                        const projectId = form.dataset.projectId;
                        const existingProject = projectId ? state.projects.find(p => p.id === projectId) : {};
                        item = {
                            ...existingProject,
                            id: projectId || `project_${Date.now()}`,
                            createdAt: projectId ? existingProject.createdAt : Date.now(),
                            name: formData.get('name'),
                            description: formData.get('description'),
                        };
                        break;
                    case 'note-form':
                        storeName = 'notes';
                        const noteId = form.dataset.noteId;
                        const existingNote = noteId ? state.notes.find(n => n.id === noteId) : {};
                        item = {
                            ...existingNote,
                            id: noteId || `note_${Date.now()}`,
                            createdAt: noteId ? existingNote.createdAt : Date.now(),
                            title: formData.get('title'),
                            content: formData.get('content'),
                            dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null,
                        };
                        break;
                }

                if(item && storeName) {
                    await dbService.add(storeName, item);
                    await refreshState();
                    render();
                    closeModal();
                }
            }
            
            // --- EVENT HANDLERS ---
            
            // BUGFIX: New function to attach event listener directly to the form
            function setupFormEventListeners() {
                const form = $('#modal-body form');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
            }

            function handleNavClick(e) {
                const navItem = e.target.closest('.nav-item');
                if (!navItem) return;

                // If we are navigating away from any iframe view, blank it to stop its content
                const contentIframe = $('#content-iframe');
                if (contentIframe && contentIframe.src !== 'about:blank') {
                    contentIframe.src = 'about:blank';
                }

                const view = navItem.dataset.view;
                const iframeUrl = navItem.dataset.iframeUrl;
                const iframeTitle = navItem.dataset.iframeTitle;

                // If the clicked item is an iframe link, set it up
                if (iframeUrl) {
                    if (contentIframe) contentIframe.src = iframeUrl;
                    const iframeTitleEl = $('#iframe-title');
                    if (iframeTitleEl) iframeTitleEl.textContent = iframeTitle || 'External Content';
                }

                state.activeView = view;
                state.activeProjectId = null; // Reset active project when navigating away

                $$('.nav-item').forEach(el => el.classList.remove('active'));
                navItem.classList.add('active');

                render();
            }

            async function handleTaskActions(e) {
                const taskCard = e.target.closest('.card[data-task-id]');
                if (!taskCard) return;
                const taskId = taskCard.dataset.taskId;

                // Complete toggle
                if (e.target.closest('.task-complete-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if(task) {
                        task.completed = !task.completed;
                        task.completedAt = task.completed ? Date.now() : null;
                        task.status = task.completed ? 'done' : 'pending'; // Sync status
                        await dbService.add('tasks', task);
                        await refreshState();
                        if (state.activeView === 'kanban-view' && state.activeProjectId) {
                           renderKanbanView(state.activeProjectId);
                        } else {
                           render();
                        }
                    }
                }
                
                // Edit button
                if (e.target.closest('.task-edit-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        // BUGFIX: Pass the setup function as a callback
                        openModal('Edit Task', getTaskFormHtml(task), setupFormEventListeners);
                    }
                }

                // Delete button
                if (e.target.closest('.task-delete-btn')) {
                    showConfirmationModal('Delete Task', 'Are you sure you want to delete this task?', async () => {
                        await dbService.delete('tasks', taskId);
                        await refreshState();
                        render();
                    });
                }
            }
            
            async function handleProjectActions(e) {
                const projectCard = e.target.closest('.card[data-project-id]');
                if (!projectCard) return;
                const projectId = projectCard.dataset.projectId;

                if (e.target.closest('.project-kanban-btn')) {
                    state.activeView = 'kanban-view';
                    state.activeProjectId = projectId;
                    render();
                }

                if (e.target.closest('.project-edit-btn')) {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        // BUGFIX: Pass the setup function as a callback
                        openModal('Edit Project', getProjectFormHtml(project), setupFormEventListeners);
                    }
                }

                if (e.target.closest('.project-delete-btn')) {
                    showConfirmationModal('Delete Project', 'Are you sure you want to delete this project? This will remove the project from all associated tasks, but will not delete the tasks themselves.', async () => {
                        const tasksToUpdate = state.tasks.filter(t => t.projectId === projectId);
                        for (const task of tasksToUpdate) {
                            task.projectId = '';
                            await dbService.add('tasks', task);
                        }
                        await dbService.delete('projects', projectId);
                        await refreshState();
                        render();
                    });
                }
            }

            async function handleNoteActions(e) {
                const noteCard = e.target.closest('.card[data-note-id]');
                if (!noteCard) return;
                const noteId = noteCard.dataset.noteId;

                if (e.target.closest('.note-edit-btn')) {
                    const note = state.notes.find(n => n.id === noteId);
                    if (note) {
                        // BUGFIX: Pass the setup function as a callback
                        openModal('Edit Note', getNoteFormHtml(note), setupFormEventListeners);
                    }
                }

                if (e.target.closest('.note-delete-btn')) {
                     showConfirmationModal('Delete Note', 'Are you sure you want to delete this note?', async () => {
                        await dbService.delete('notes', noteId);
                        await refreshState();
                        render();
                    });
                }
            }
            
             function openSettingsModal() {
                const content = `
                    <div class="space-y-6">
                        <p class="text-gray-600 dark:text-gray-300">Customize the interface colors to fit your style.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                            <label class="font-semibold">Primary Color</label>
                            <div class="flex items-center gap-4">
                                <input type="color" id="primary-color-picker" value="${state.primaryColor}" class="h-10 w-16 p-1 rounded-md cursor-pointer">
                                <span id="primary-color-value" class="font-mono">${state.primaryColor}</span>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-center">
                            <label class="font-semibold">Secondary Color</label>
                            <div class="flex items-center gap-4">
                                <input type="color" id="secondary-color-picker" value="${state.secondaryColor}" class="h-10 w-16 p-1 rounded-md cursor-pointer">
                                <span id="secondary-color-value" class="font-mono">${state.secondaryColor}</span>
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4 border-t dark:border-gray-700">
                             <button id="save-settings-btn" class="btn btn-primary">Save Changes</button>
                        </div>
                    </div>
                `;
                
                openModal('Customization Settings', content, () => {
                    const primaryPicker = $('#primary-color-picker');
                    const secondaryPicker = $('#secondary-color-picker');

                    // Live preview
                    primaryPicker.addEventListener('input', (e) => {
                        applyColors(e.target.value, state.secondaryColor);
                        $('#primary-color-value').textContent = e.target.value;
                    });
                    secondaryPicker.addEventListener('input', (e) => {
                         applyColors(state.primaryColor, e.target.value);
                         $('#secondary-color-value').textContent = e.target.value;
                    });

                    // Save button
                    $('#save-settings-btn').addEventListener('click', () => {
                        saveColorsToStorage(primaryPicker.value, secondaryPicker.value);
                        closeModal();
                        const notification = $('#saveNotification');
                        notification.textContent = 'Settings saved!';
                        notification.classList.add('show');
                        setTimeout(() => notification.classList.remove('show'), 3000);
                    });
                });
            }

            function openGoogleSyncModal() {
                const tasksWithDates = state.tasks.filter(t => t.dueDate);
                let modalContent;
                if (tasksWithDates.length > 0) {
                    modalContent = tasksWithDates.map(task => `
                        <div class="flex justify-between items-center p-3 border-b dark:border-gray-700">
                            <div>
                                <div class="font-semibold">${task.title}</div>
                                <div class="text-sm text-gray-500">${new Date(task.dueDate).toLocaleDateString('en-US')}</div>
                            </div>
                            <button class="add-to-google-btn btn btn-primary text-sm py-1 px-3" data-task-id="${task.id}">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add to Google
                            </button>
                        </div>
                    `).join('');
                } else {
                    modalContent = `<p class="text-gray-500 text-center p-4">You have no tasks with due dates to sync.</p>`;
                }
                openModal('Sync Tasks with Google Calendar', modalContent);
            }

            function handleAddToGoogle(e) {
                const button = e.target.closest('.add-to-google-btn');
                if (!button) return;

                const taskId = button.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (!task || !task.dueDate) return;

                function toGoogleDate(date) {
                    return new Date(date).toISOString().replace(/-|:|\.\d{3}/g, '').split('T')[0];
                }

                const googleDate = toGoogleDate(task.dueDate);

                const url = new URL('https://www.google.com/calendar/render');
                url.searchParams.set('action', 'TEMPLATE');
                url.searchParams.set('text', task.title);
                url.searchParams.set('dates', `${googleDate}/${googleDate}`); // All-day event
                url.searchParams.set('details', task.description || 'Task from Headquarters');
                
                window.open(url.toString(), '_blank');
            }

            function setupKanbanEventListeners(projectId) {
                const tasks = $$('#kanban-view .kanban-task');
                const columns = $$('#kanban-view .kanban-tasks-container');

                tasks.forEach(task => {
                    task.addEventListener('dragstart', (event) => {
                        task.classList.add('dragging');
                        event.dataTransfer.setData('text/plain', task.dataset.taskId);
                    });

                    task.addEventListener('dragend', () => {
                        task.classList.remove('dragging');
                    });
                });

                columns.forEach(col => {
                    col.addEventListener('dragover', event => {
                        event.preventDefault();
                        col.parentElement.classList.add('drag-over');
                    });

                    col.addEventListener('dragleave', () => {
                        col.parentElement.classList.remove('drag-over');
                    });

                    col.addEventListener('drop', async event => {
                        event.preventDefault();
                        col.parentElement.classList.remove('drag-over');
                        
                        const taskId = event.dataTransfer.getData('text/plain');
                        const task = state.tasks.find(t => t.id === taskId);
                        if (!task) return;

                        const newStatus = col.id.replace('kanban-', ''); // 'pending', 'progress', or 'done'
                        if (task.status !== newStatus) {
                            task.status = newStatus;
                            task.completed = (newStatus === 'done');
                            task.completedAt = task.completed ? Date.now() : null;

                            await dbService.add('tasks', task);
                            await refreshState();
                            renderKanbanView(projectId);
                        }
                    });
                });
            }

            function setupEventListeners() {
                // Navigation
                $('.sidebar nav').addEventListener('click', handleNavClick);
                
                // List actions (delegated)
                $('#tasks-list').addEventListener('click', handleTaskActions);
                $('#projects-list').addEventListener('click', handleProjectActions);
                $('#notes-list').addEventListener('click', handleNoteActions);
                $('#back-to-projects-btn').addEventListener('click', () => {
                    state.activeView = 'projects';
                    state.activeProjectId = null;
                    render();
                });

                // Task Filter actions (delegated)
                $('#tasks').addEventListener('input', e => {
                    if (e.target.id === 'task-search-input') {
                        state.taskSearchQuery = e.target.value;
                        renderTasks();
                    }
                });
                $('#tasks').addEventListener('click', e => {
                    if (e.target.matches('.tag-filter-btn')) {
                        const tag = e.target.dataset.tag;
                        state.activeTagFilter = state.activeTagFilter === tag ? null : tag;
                        renderTasks();
                    }
                    if (e.target.matches('#clear-tag-filter-btn')) {
                        state.activeTagFilter = null;
                        renderTasks();
                    }
                });

                // Theme & Settings
                $('#settings-btn').addEventListener('click', openSettingsModal);
                $('#theme-toggle').addEventListener('click', () => {
                    const html = document.documentElement;
                    html.classList.toggle('dark');
                    const isDark = html.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    $('#theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'moon' : 'sun'}"></i><span>${isDark ? 'Dark Mode' : 'Light Mode'}</span>`;
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                    render(); // Re-render to apply changes like the calendar toggle
                });

                // Modal Controls
                $('#modal-container').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-container' || e.target.closest('#modal-close') || e.target.id === 'modal-cancel') {
                        closeModal();
                        loadColorsFromStorage(); // Revert to saved colors if modal is cancelled
                    }
                });
                $('#modal-body').addEventListener('click', handleAddToGoogle); // Delegated listener for google sync buttons

                // "Add" buttons
                $('#btn-add-task').addEventListener('click', () => openModal('Add New Task', getTaskFormHtml(), setupFormEventListeners));
                $('#add-task-from-view').addEventListener('click', () => openModal('Add New Task', getTaskFormHtml(), setupFormEventListeners));

                $('#btn-add-project').addEventListener('click', () => openModal('Add New Project', getProjectFormHtml(), setupFormEventListeners));
                $('#add-project-from-view').addEventListener('click', () => openModal('Add New Project', getProjectFormHtml(), setupFormEventListeners));
                
                $('#btn-add-note').addEventListener('click', () => openModal('Add New Note', getNoteFormHtml(), setupFormEventListeners));
                $('#add-note-from-view').addEventListener('click', () => openModal('Add New Note', getNoteFormHtml(), setupFormEventListeners));

                // Calendar Controls
                $('#calendar-prev').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() - 7);
                    }
                    renderCalendar();
                });
                $('#calendar-next').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() + 7);
                    }
                    renderCalendar();
                });
                $('#calendar-view-month').addEventListener('click', () => {
                    state.calendarView = 'month';
                    renderCalendar();
                });
                $('#calendar-view-week').addEventListener('click', () => {
                    state.calendarView = 'week';
                    renderCalendar();
                });

                // ICS Download & Google Sync
                $('#download-ics-btn').addEventListener('click', downloadICS);
                $('#sync-google-btn').addEventListener('click', openGoogleSyncModal);
            }

            function downloadICS() {
                let ics_content = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Headquarters//EN
`;
                const allEvents = getAllCalendarEvents();
                allEvents.forEach(event => {
                    if(event.dueDate) {
                        const startDate = new Date(event.dueDate).toISOString().replace(/-|:|\.\\d\\d\\d/g,"");
                        const summary = event.type === 'note' ? `Reminder: ${event.title}` : event.title;
                        ics_content += `BEGIN:VEVENT
UID:${event.id}@headquarters
DTSTAMP:${new Date().toISOString().replace(/-|:|\.\\d\\d\\d/g,"")}
DTSTART;VALUE=DATE:${startDate.substring(0,8)}
SUMMARY:${summary}
DESCRIPTION:${event.description || event.content || ''}
END:VEVENT
`;
                    }
                });
                ics_content += 'END:VCALENDAR';

                const blob = new Blob([ics_content], {type: 'text/calendar;charset=utf-8'});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "headquarters_calendar.ics";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }
            
            async function refreshState() {
                try {
                    [state.tasks, state.projects, state.notes] = await Promise.all([
                        dbService.getAll('tasks'),
                        dbService.getAll('projects'),
                        dbService.getAll('notes'),
                    ]);

                    // Migrate old tasks without a status
                    state.tasks = state.tasks.map(task => {
                        if (!task.status) {
                            task.status = task.completed ? 'done' : 'pending';
                        }
                        return task;
                    });

                    // Default sort can be by creation date
                    state.tasks.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.projects.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.notes.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                } catch(e) {
                    console.error("Could not refresh state from DB", e);
                }
            }

            // --- INITIALIZATION ---
            async function init() {
                // Set initial theme and colors
                loadColorsFromStorage();
                const theme = localStorage.getItem('theme');
                const isDark = theme === 'dark' || (theme === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) {
                    document.documentElement.classList.add('dark');
                }
                $('#theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'moon' : 'sun'}"></i><span>${isDark ? 'Dark Mode' : 'Light Mode'}</span>`;
                
                if (window.lucide) {
                   lucide.createIcons();
                }

                setupEventListeners();
                
                try {
                    await dbService.init();
                    await refreshState();
                    render();
                } catch(e) {
                    console.error("Initialization failed", e);
                    $('main').innerHTML = `<div class="text-red-500 p-8">Error: Could not initialize the application. Please check the console for more details.</div>`;
                }
            }

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
</body>
</html>
