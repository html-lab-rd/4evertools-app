<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>

    <!-- Favicon -->
    <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/20b9de7f326dedf80fb4b5a26e56f7a4ffe824f4.png">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #df1783;
            --secondary: #8c318f;
            --accent: rgba(255,255,255,0.1);
            --light: #f8f9fa;
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
            --dark-text: #e2e8f0;
        }

        html.dark {
            --light: var(--dark-bg);
            --dark-text: #e2e8f0;
        }

        .custom-image-widget {
            position: fixed !important;
            top: 50px !important;
            margin: 0 !important;
            padding: 0 !important;
            right: 0px;
            z-index: 999;
        }
        
        .custom-image {
            width: 70px;
            height: auto;
            transition: transform 0.2s;
        }
        
        .custom-image-widget:hover .custom-image {
            transform: scale(1.2);
        }
        
        .custom-image-widget:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            min-height: 100vh;
            background-color: #eef2f7;
            color: #333;
        }

        html.dark body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: background 0.5s ease;
        }

        .nav-item {
            transition: all 0.3s;
        }

        .nav-item:hover {
            background-color: var(--accent);
        }

        .nav-item.active {
            background-color: var(--accent);
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html.dark .card {
            background: var(--dark-card);
        }

        input, select, textarea {
            background-color: #fbfbfb;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            color: #333;
            transition: all 0.2s;
        }
        html.dark input, html.dark select, html.dark textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: var(--dark-text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(223, 23, 131, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            padding: 10px 20px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-cancel {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-cancel:hover {
            background-color: #d1d5db;
        }
        html.dark .btn-cancel {
            background-color: #4b5563;
            color: var(--dark-text);
        }
        html.dark .btn-cancel:hover {
            background-color: #6b7280;
        }

        .bg-primary { background-color: var(--primary); }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
        }
        html.dark .calendar-grid { background-color: #4a5568; }

        .calendar-day, .calendar-header {
            background-color: white;
            padding: 8px;
        }
        html.dark .calendar-day, html.dark .calendar-header { background-color: var(--dark-card); }
        .calendar-header { font-weight: bold; text-align: center; }

        .calendar-day { min-height: 120px; }
        .calendar-day.other-month { background-color: #f1f5f9; }
        html.dark .calendar-day.other-month { background-color: #1a202c; color: #718096; }

        .calendar-task {
            background-color: #fecdd3;
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        html.dark .calendar-task { background-color: #b91c1c; color: white; }

        .calendar-note {
            background-color: #fef9c3;
            color: #a16207;
            border-left: 3px solid #f59e0b;
        }
        html.dark .calendar-note { 
            background-color: #451a03;
            color: #fef08a;
        }

        /* Modal Styles */
        #modal-container {
            transition: opacity 0.3s ease;
        }
        #modal-content {
            transition: transform 0.3s ease;
        }

        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .section-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 10px;
        }
        html.dark .section-footer {
            border-top-color: #4a5568;
            color: #a0aec0;
        }
        
        /* Kanban Styles */
        .kanban-task {
            cursor: grab;
        }
        .kanban-task.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .kanban-col.drag-over {
            background-color: var(--accent);
            border-radius: 0.5rem;
        }
        html.dark .kanban-col.drag-over {
             background-color: rgba(255, 255, 255, 0.05);
        }

        /* Activity Heatmap Section Fixes */
        .activity-heatmap-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html.dark .activity-heatmap-card { background: var(--dark-card); }

        .activity-heatmap-card-content { display: flex; flex-direction: column; gap: 1.5rem; }
        
        .contribution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .calendar-wrapper {
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .month-labels {
            display: flex;
            margin-left: 32px;
            gap: 4px;
            height: 20px;
        }
        
        .month-label {
            font-size: 10px;
            color: #6b7280;
            min-width: 48px;
        }

        .contribution-grid { display: flex; gap: 4px; }

        .weekday-labels { 
            display: grid; 
            grid-template-rows: repeat(7, 12px); 
            gap: 4px; 
            width: 32px; 
            margin-top: 2px;
        }

        .weekday-label { 
            height: 12px; 
            font-size: 10px; 
            line-height: 12px; 
            text-align: right; 
            padding-right: 6px; 
            color: #6b7280;
        }

        .weeks-container { display: flex; gap: 4px; }
        .week-column { display: flex; flex-direction: column; gap: 4px; }

        .contribution-cell { 
            width: 12px; 
            height: 12px; 
            border-radius: 2px; 
            background-color: #f3f4f6; 
            transition: transform 0.1s;
        }
        html.dark .contribution-cell { background-color: #374151; }
        .contribution-cell:hover { transform: scale(1.3); }

        .contribution-controls { display: flex; gap: 0.5rem; justify-content: center; }
        .contribution-btn {
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
        }
        html.dark .contribution-btn { background: #4b5563; color: white; }
        .contribution-btn:hover { background: var(--primary); color: white; }

        @media (min-width: 1280px) {
            .activity-heatmap-card-content { flex-direction: row; align-items: flex-end; }
            .contribution-controls { flex-direction: column; width: 140px; }
        }

        /* Level Colors */
        .level-1 { background-color: #f8b8d9 !important; }
        .level-2 { background-color: #f28bc5 !important; }
        .level-3 { background-color: #e95eb0 !important; }
        .level-4 { background-color: #df1783 !important; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg flex h-screen">

    <!-- Sidebar -->
    <div class="sidebar w-64 flex-shrink-0 flex flex-col p-6">
        <div class="mb-10">
            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                <i data-lucide="zap" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Headquarters</h1>
            <p class="text-white/80 text-sm leading-relaxed">Your productivity command center.</p>
        </div>
        
        <nav class="flex-grow space-y-2">
            <div id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
            <div id="nav-tasks" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="tasks"><i data-lucide="check-square"></i><span>Tasks</span></div>
            <div id="nav-projects" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="projects"><i data-lucide="folder-kanban"></i><span>Projects</span></div>
            <div id="nav-notes" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="notes"><i data-lucide="notebook-pen"></i><span>Notes</span></div>
            <div id="nav-calendar" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="calendar"><i data-lucide="calendar-days"></i><span>Calendar</span></div>
            
            <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" 
                 data-view="iframe-view" 
                 data-iframe-url="https://bebell-digital-solutions.github.io/aiba-deepseek/en-v03" 
                 data-iframe-title="AI Assistant">
                <i data-lucide="bot"></i><span>AI Assistant</span>
            </div>

            <button id="theme-toggle" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="sun" class="w-5 h-5"></i><span>Light Mode</span>
            </button>
        </nav>

        <div class="space-y-3 mt-auto">
             <button id="settings-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="palette" class="w-5 h-5"></i><span>Customization</span>
            </button>
            <a href="https://www.notion.so/templates" target="_blank" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent">
                 <i data-lucide="download" class="w-5 h-5"></i><span>Notion Templates</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow p-8 overflow-y-auto">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section space-y-8">
            <div>
                <h1 class="text-4xl font-bold">Dashboard</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Here's your productivity summary for today.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-add-task" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> New Task
                </button>
                <button id="btn-add-note" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> Quick Note
                </button>
                <button id="btn-add-project" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> New Project
                </button>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                <!-- Stats will be rendered here by JS -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Task Completion Status</h2>
                    <div class="relative flex-grow min-h-[250px]">
                        <canvas id="task-completion-chart"></canvas>
                    </div>
                </div>
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">This Week's Reminders</h2>
                    <div id="weekly-deadlines" class="flex-grow overflow-y-auto max-h-[268px]">
                        <!-- Weekly deadlines will be rendered here by JS -->
                    </div>
                </div>
            </div>

            <!-- ACTIVITY HEATMAP CARD -->
            <div class="activity-heatmap-card">
                <div class="activity-heatmap-card-content">
                    <div class="heatmap-visual-container flex-grow">
                        <div class="contribution-header">
                            <div id="totalContributions">0 activities</div>
                            <div id="currentYearDisplay">2025</div>
                        </div>
                        <div class="calendar-wrapper">
                            <div class="month-labels" id="monthLabels"></div>
                            <div class="contribution-grid">
                                <div class="weekday-labels" id="weekdayLabels"></div>
                                <div class="weeks-container" id="weeksContainer"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="contribution-controls">
                        <button class="contribution-btn" id="btnPrevYear">‚Üê Prev Year</button>
                        <button class="contribution-btn" id="btnCurrentYear">Current</button>
                        <button class="contribution-btn" id="btnNextYear">Next Year ‚Üí</button>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                 <h2 class="text-xl font-bold mb-4">Tasks Overview</h2>
                 <div id="dashboard-tasks" class="text-gray-600 dark:text-gray-300">Loading tasks...</div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">Calendar Preview</h2>
                <div id="dashboard-calendar-preview">Loading calendar...</div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Tasks</h1>
                <button id="add-task-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Task
                </button>
            </div>
            <div id="tasks-filter-container" class="card p-4 mb-6"></div>
            <div id="tasks-list" class="space-y-4"></div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Projects</h1>
                 <button id="add-project-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Project
                </button>
            </div>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Notes Section -->
        <section id="notes" class="section hidden">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Notes</h1>
                 <button id="add-note-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> Add New Note
                </button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section hidden space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-4xl font-bold">Calendar</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                         <button id="sync-google-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white text-sm py-2">
                             <i data-lucide="calendar-plus"></i> Sync with Google
                        </button>
                        <button id="download-ics-btn" class="btn bg-green-500 hover:bg-green-600 text-white text-sm py-2">
                            <i data-lucide="download-cloud"></i> Download .ICS
                        </button>
                    </div>
                    <div class="flex items-center rounded-lg p-1 bg-primary text-white">
                        <button id="calendar-view-month" class="px-3 py-1 text-sm rounded-md">Month</button>
                        <button id="calendar-view-week" class="px-3 py-1 text-sm rounded-md">Week</button>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">Today's Tasks</h2>
                <div id="calendar-today-tasks"></div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                     <button id="calendar-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-left"></i></button>
                     <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                     <button id="calendar-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendar-container"></div>
            </div>
        </section>
        
        <!-- IFrame Container Section -->
        <section id="iframe-view" class="section hidden h-full flex flex-col">
            <h1 id="iframe-title" class="text-4xl font-bold mb-6 flex-shrink-0"></h1>
            <div class="flex-grow rounded-xl overflow-hidden shadow-lg">
                <iframe id="content-iframe" class="w-full h-full border-0" src="about:blank"></iframe>
            </div>
        </section>

        <!-- Kanban View Section -->
        <section id="kanban-view" class="section hidden h-full flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h1 class="text-4xl font-bold truncate pr-4">Kanban: <span id="kanban-project-title"></span></h1>
                <button id="back-to-projects-btn" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">
                    <i data-lucide="arrow-left"></i>
                    <span class="hidden sm:inline">Back to Projects</span>
                </button>
            </div>
            <div id="kanban-board" class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-x-auto">
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-red-500 flex-shrink-0">To Do</h2>
                    <div id="kanban-pending" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-yellow-500 flex-shrink-0">In Progress</h2>
                    <div id="kanban-progress" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
                <div class="kanban-col bg-gray-200/50 dark:bg-dark-bg/50 p-4 rounded-lg flex flex-col">
                    <h2 class="font-bold text-lg mb-4 pb-2 border-b-2 border-green-500 flex-shrink-0">Done</h2>
                    <div id="kanban-done" class="kanban-tasks-container space-y-4 min-h-[200px] flex-grow overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <footer class="section-footer">
            <p>Developed with üíñ by <a href="https://bebelldigitalsolutions.com" target="_blank" rel="noopener noreferrer" class="hover:"><strong style="color:var(--primary);">Bebell Digital Solutions</strong></a></p>
            <p>Copyright ¬© 2025 ‚Ä¢ All rights reserved</p>
        </footer>
    </main>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center p-4 opacity-0">
        <div id="modal-content" class="card w-full max-w-2xl transform -translate-y-10">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-600">
                <h2 id="modal-title" class="text-2xl font-bold">Modal Title</h2>
                <button id="modal-close" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <div class="save-notification" id="saveNotification">
        Data saved successfully!
    </div>

    <script>
        (function() {
            'use strict';

            // --- STATE MANAGEMENT & GLOBALS ---
            const state = {
                tasks: [],
                projects: [],
                notes: [],
                activeView: 'dashboard',
                activeProjectId: null,
                calendarDate: new Date(),
                calendarView: 'month',
                taskSearchQuery: '',
                activeTagFilter: null,
                primaryColor: '#df1783',
                secondaryColor: '#8c318f'
            };
            let taskCompletionChart = null;

            // Activity Tracker Class Definition
            class ActivityTracker {
                constructor() {
                    this.weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    this.months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    this.year = new Date().getFullYear();
                }

                init() {
                    document.getElementById('btnPrevYear').onclick = () => { this.year--; this.render(); };
                    document.getElementById('btnNextYear').onclick = () => { this.year++; this.render(); };
                    document.getElementById('btnCurrentYear').onclick = () => { this.year = new Date().getFullYear(); this.render(); };
                }

                getActivityMap() {
                    const map = {};
                    state.tasks.forEach(t => {
                        if (t.completed && t.completedAt) {
                            const d = new Date(t.completedAt).toISOString().split('T')[0];
                            map[d] = (map[d] || 0) + 1;
                        }
                    });
                    state.notes.forEach(n => {
                        if (n.createdAt) {
                            const d = new Date(n.createdAt).toISOString().split('T')[0];
                            map[d] = (map[d] || 0) + 1;
                        }
                    });
                    return map;
                }

                render() {
                    const wLab = document.getElementById('weekdayLabels');
                    const wCont = document.getElementById('weeksContainer');
                    const mLab = document.getElementById('monthLabels');
                    const totalDisp = document.getElementById('totalContributions');
                    const yearDisp = document.getElementById('currentYearDisplay');

                    if (!wLab || !wCont) return;

                    wLab.innerHTML = ''; wCont.innerHTML = ''; mLab.innerHTML = '';
                    yearDisp.textContent = this.year;

                    const activityMap = this.getActivityMap();
                    let totalInYear = 0;

                    this.weekdays.forEach(day => {
                        const div = document.createElement('div');
                        div.className = 'weekday-label';
                        div.textContent = day;
                        wLab.appendChild(div);
                    });

                    const date = new Date(this.year, 0, 1);
                    const startPadding = date.getDay();
                    date.setDate(date.getDate() - startPadding);

                    let lastMonth = -1;

                    for (let w = 0; w < 53; w++) {
                        const col = document.createElement('div');
                        col.className = 'week-column';
                        
                        for (let d = 0; d < 7; d++) {
                            const cell = document.createElement('div');
                            cell.className = 'contribution-cell';
                            
                            const iso = date.toISOString().split('T')[0];
                            const count = activityMap[iso] || 0;
                            
                            if (date.getFullYear() === this.year) {
                                totalInYear += count;
                                if (count > 0) {
                                    const level = Math.min(4, Math.ceil(count / 2));
                                    cell.classList.add(`level-${level}`);
                                }
                                cell.title = `${iso}: ${count} activities`;

                                if (d === 0 && date.getMonth() !== lastMonth) {
                                    const mSpan = document.createElement('span');
                                    mSpan.className = 'month-label';
                                    mSpan.textContent = this.months[date.getMonth()];
                                    mLab.appendChild(mSpan);
                                    lastMonth = date.getMonth();
                                }
                            }
                            
                            col.appendChild(cell);
                            date.setDate(date.getDate() + 1);
                        }
                        wCont.appendChild(col);
                    }
                    totalDisp.textContent = `${totalInYear} activities in ${this.year}`;
                }
            }

            const activityTracker = new ActivityTracker();

            // --- DATABASE SERVICE ---
            const dbService = {
                db: null,
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('HeadquartersDB', 2);
                        request.onerror = e => reject('Error opening DB', e);
                        request.onsuccess = e => {
                            this.db = e.target.result;
                            resolve();
                        };
                        request.onupgradeneeded = e => {
                            const db = e.target.result;
                            const stores = ['tasks', 'projects', 'notes'];
                            stores.forEach(s => {
                                if (!db.objectStoreNames.contains(s)) {
                                    db.createObjectStore(s, { keyPath: 'id' });
                                }
                            });
                        };
                    });
                },
                async add(storeName, item) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error on ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.put(item).onerror = e => reject(`Error adding/updating in ${storeName}`, e.target.error);
                    });
                },
                async getAll(storeName) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readonly');
                        const store = tx.objectStore(storeName);
                        const req = store.getAll();
                        req.onsuccess = e => resolve(e.target.result);
                        req.onerror = e => reject(`Error getting all from ${storeName}`, e.target.error);
                    });
                },
                async delete(storeName, key) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Transaction error on ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.delete(key).onerror = e => reject(`Error deleting from ${storeName}`, e.target.error);
                    });
                },
            };

            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            
            function applyColors(primary, secondary) {
                const root = document.documentElement;
                state.primaryColor = primary;
                state.secondaryColor = secondary;
                root.style.setProperty('--primary', primary);
                root.style.setProperty('--secondary', secondary);
            }

            function saveColorsToStorage(primary, secondary) {
                localStorage.setItem('headquarters-colors', JSON.stringify({ primary, secondary }));
            }

            function loadColorsFromStorage() {
                const savedColors = localStorage.getItem('headquarters-colors');
                if (savedColors) {
                    const { primary, secondary } = JSON.parse(savedColors);
                    applyColors(primary, secondary);
                } else {
                    applyColors(state.primaryColor, state.secondaryColor);
                }
            }

            function getPriorityInfo(priority) {
                switch (priority) {
                    case 'p1': return { icon: 'chevrons-up', text: 'Highest', badge: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' };
                    case 'p2': return { icon: 'chevron-up', text: 'High', badge: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300' };
                    case 'p3': return { icon: 'equal', text: 'Medium', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                    case 'p4': return { icon: 'chevron-down', text: 'Low', badge: 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300' };
                    default: return { icon: 'equal', text: 'Medium', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                }
            }

            function getStatusInfo(status) {
                switch (status) {
                    case 'progress': return { text: 'In Progress', badge: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' };
                    case 'done': return { text: 'Done', badge: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' };
                    default: return { text: 'To Do', badge: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                }
            }

            function getAllCalendarEvents() {
                const taskEvents = state.tasks.filter(t => t.dueDate).map(t => ({...t, type: 'task'}));
                const noteEvents = state.notes.filter(n => n.dueDate).map(n => ({...n, type: 'note'}));
                return [...taskEvents, ...noteEvents];
            }

            function render() {
                $$('.section').forEach(el => el.classList.add('hidden'));
                const activeSection = $(`#${state.activeView}`);
                if (activeSection) activeSection.classList.remove('hidden');

                switch(state.activeView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'tasks': renderTasks(); break;
                    case 'projects': renderProjects(); break;
                    case 'notes': renderNotes(); break;
                    case 'calendar': renderCalendar(); break;
                    case 'kanban-view':
                        if (state.activeProjectId) renderKanbanView(state.activeProjectId);
                        break;
                }
                if (window.lucide) lucide.createIcons();
            }
            
            function renderDashboard() {
                activityTracker.render();
                const statsContainer = $('#dashboard-stats');
                const pendingTasksCount = state.tasks.filter(t => !t.completed).length;
                const activeProjects = state.projects.length; 
                const totalNotes = state.notes.length;

                statsContainer.innerHTML = `
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full"><i data-lucide="list-checks" class="text-blue-500"></i></div>
                        <div><div class="text-2xl font-bold">${pendingTasksCount}</div><div class="text-gray-500 dark:text-gray-400">Pending Tasks</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full"><i data-lucide="folder-kanban" class="text-purple-500"></i></div>
                        <div><div class="text-2xl font-bold">${activeProjects}</div><div class="text-gray-500 dark:text-gray-400">Active Projects</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full"><i data-lucide="notebook-pen" class="text-yellow-500"></i></div>
                        <div><div class="text-2xl font-bold">${totalNotes}</div><div class="text-gray-500 dark:text-gray-400">Total Notes</div></div>
                    </div>
                `;

                const completedTasks = state.tasks.filter(t => t.completed).length;
                const pendingChartTasks = state.tasks.length - completedTasks;
                const totalTasks = state.tasks.length;
                
                if (taskCompletionChart) taskCompletionChart.destroy();
                
                const canvas = $('#task-completion-chart');
                if (canvas) {
                    const chartCtx = canvas.getContext('2d');
                    const chartData = {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completedTasks, pendingChartTasks],
                            backgroundColor: ['#22c55e', '#ef4444'],
                            borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                            borderWidth: 4
                        }]
                    };

                    const chartOptions = {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'bottom', labels: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#333', padding: 20 } },
                            tooltip: { enabled: true }
                        },
                        cutout: '70%'
                    };

                    if (totalTasks === 0) {
                        chartData.labels = ['No Tasks'];
                        chartData.datasets = [{ data: [1], backgroundColor: [document.documentElement.classList.contains('dark') ? '#4a5568' : '#e5e7eb'], borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff', borderWidth: 4 }];
                        chartOptions.plugins.tooltip.enabled = false;
                        chartOptions.plugins.legend.display = false;
                    }
                    taskCompletionChart = new Chart(chartCtx, { type: 'doughnut', data: chartData, options: chartOptions });
                }

                const weeklyDeadlinesContainer = $('#weekly-deadlines');
                if (weeklyDeadlinesContainer) {
                    const todayForWeek = new Date();
                    const startOfWeek = new Date(todayForWeek.setDate(todayForWeek.getDate() - todayForWeek.getDay()));
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);

                    const thisWeeksTasks = state.tasks
                        .filter(t => !t.completed && t.dueDate && t.dueDate >= startOfWeek.getTime() && t.dueDate <= endOfWeek.getTime())
                        .sort((a, b) => a.dueDate - b.dueDate);
                    
                    const priorityIcons = { p1: 'üî•', p2: '‚ö†Ô∏è', p3: 'üîµ', p4: '‚¨áÔ∏è' };
                    const header = `<div class="grid grid-cols-[50px_60px_1fr_40px] gap-4 px-2 pb-2 border-b border-gray-300 dark:border-gray-600"><span class="font-bold text-xs uppercase text-gray-400">Day</span><span class="font-bold text-xs uppercase text-gray-400">Date</span><span class="font-bold text-xs uppercase text-gray-400">Task</span><span class="font-bold text-xs uppercase text-gray-400 text-center">üîî</span></div>`;

                    let content;
                    if (thisWeeksTasks.length > 0) {
                        content = `<div class="mt-2">${thisWeeksTasks.map((task) => {
                            const dueDate = new Date(task.dueDate);
                            const day = dueDate.toLocaleDateString('en-US', { weekday: 'short' }).replace('.', '');
                            const date = dueDate.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit' });
                            return `<div class="grid grid-cols-[50px_60px_1fr_40px] gap-4 items-center py-2 px-2 border-b border-gray-200 dark:border-gray-700 last:border-b-0"><span class="font-semibold text-sm capitalize">${day}</span><span class="text-sm text-gray-600 dark:text-gray-400">${date}</span><span class="text-sm truncate" title="${task.title}">${task.title}</span><span class="text-center text-lg">${priorityIcons[task.priority] || 'üîµ'}</span></div>`;
                        }).join('')}</div>`;
                    } else {
                        // UPDATED: Bolt icon color to gray-400 in light mode (visible but light) and gray-600 in dark mode
                        content = `<div class="flex flex-col items-center justify-center text-center py-8"><i data-lucide="zap" class="w-16 h-16 text-gray-400 dark:text-gray-600 mb-4"></i><p class="text-gray-500">No deadlines this week!</p></div>`;
                    }
                    weeklyDeadlinesContainer.innerHTML = header + content;
                }

                const taskOverview = $('#dashboard-tasks');
                const incompleteTasks = state.tasks.filter(t => !t.completed).sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));
                if (incompleteTasks.length > 0) {
                    taskOverview.innerHTML = incompleteTasks.slice(0, 5).map(t => {
                        const priorityInfo = getPriorityInfo(t.priority);
                        return `<div class="py-3 border-b dark:border-gray-700 flex justify-between items-center"><span>${t.title}</span><span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}"><i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>${priorityInfo.text}</span></div>`;
                    }).join('');
                } else taskOverview.innerHTML = '<p class="text-gray-500">No pending tasks. Great job!</p>';

                const calendarPreview = $('#dashboard-calendar-preview');
                const upcomingEvents = getAllCalendarEvents().filter(e => (!e.completed) && e.dueDate >= new Date().setHours(0,0,0,0)).sort((a,b) => a.dueDate - b.dueDate).slice(0, 3);
                if (upcomingEvents.length > 0) {
                    calendarPreview.innerHTML = upcomingEvents.map(e => `<div class="py-2 border-b dark:border-gray-700">${e.type === 'note' ? 'üîî' : 'üóìÔ∏è'} ${e.title} - <span class="text-sm text-gray-500">${new Date(e.dueDate).toLocaleDateString('en-US')}</span></div>`).join('');
                } else calendarPreview.innerHTML = '<p class="text-gray-500">No upcoming deadlines or reminders.</p>';
            }

            function renderTasks() {
                const list = $('#tasks-list');
                const filterContainer = $('#tasks-filter-container');
                const allTags = [...new Set(state.tasks.flatMap(t => t.tags || []))].sort();

                filterContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4"><div class="flex-grow"><div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i><input id="task-search-input" type="search" placeholder="Search tasks..." class="w-full p-2 pl-10 rounded-lg" value="${state.taskSearchQuery || ''}"></div></div></div>
                    <div class="mt-4 flex items-center gap-2 flex-wrap"><span class="font-semibold text-sm">Filter:</span>${allTags.map(tag => `<button class="tag-filter-btn px-3 py-1 text-sm rounded-full ${state.activeTagFilter === tag ? 'btn-primary' : 'bg-gray-500 text-white dark:bg-gray-600'}" data-tag="${tag}">${tag}</button>`).join('')}${state.activeTagFilter ? `<button id="clear-tag-filter-btn" class="text-sm text-red-500 hover:underline">Clear</button>` : ''}</div>`;

                let filteredTasks = state.tasks;
                if (state.taskSearchQuery) {
                    const q = state.taskSearchQuery.toLowerCase();
                    filteredTasks = filteredTasks.filter(t => t.title.toLowerCase().includes(q) || (t.description && t.description.toLowerCase().includes(q)));
                }
                if (state.activeTagFilter) filteredTasks = filteredTasks.filter(t => t.tags && t.tags.includes(state.activeTagFilter));
                const sortedTasks = filteredTasks.sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));

                if(sortedTasks.length === 0) { list.innerHTML = `<div class="card p-6 text-center text-gray-500">No tasks match.</div>`; return; }
                list.innerHTML = sortedTasks.map(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const statusInfo = getStatusInfo(task.status);
                    return `<div class="card p-4 flex items-start gap-4" data-task-id="${task.id}"><button class="task-complete-btn mt-1"><i data-lucide="${task.completed ? 'check-circle-2' : 'circle'}" class="w-6 h-6 ${task.completed ? 'text-green-500' : 'text-gray-400'}"></i></button><div class="flex-grow"><div class="flex justify-between items-start gap-2"><h3 class="font-bold text-lg ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</h3><div class="flex items-center flex-shrink-0 gap-2"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusInfo.badge}">${statusInfo.text}</span><span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}"><i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>${priorityInfo.text}</span></div></div><p class="text-sm text-gray-500 mt-1">${task.description || ''}</p><div class="flex items-center gap-4 text-sm text-gray-500 mt-3 flex-wrap">${task.dueDate ? `<div>üìÖ ${new Date(task.dueDate).toLocaleDateString()}</div>` : ''}${task.tags && task.tags.length ? `<div class="flex gap-1">${task.tags.map(tag => `<span class="bg-primary text-white text-[10px] px-1.5 rounded-full">${tag}</span>`).join('')}</div>` : ''}</div></div><div class="flex gap-1"><button class="task-edit-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button><button class="task-delete-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button></div></div>`;
                }).join('');
            }

            function renderProjects() {
                const list = $('#projects-list');
                if(state.projects.length === 0) { list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No projects.</div>`; return; }
                list.innerHTML = state.projects.map(p => `<div class="card p-6 flex flex-col" data-project-id="${p.id}"><div class="flex-grow"><h3 class="font-bold text-lg mb-2 text-primary">${p.name}</h3><p class="text-gray-600 dark:text-gray-300 text-sm">${p.description || ''}</p></div><div class="mt-4 pt-4 border-t flex justify-end gap-2"><button class="project-kanban-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="layout-grid" class="w-4 h-4"></i></button><button class="project-edit-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button><button class="project-delete-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button></div></div>`).join('');
            }
            
            function renderNotes() {
                const list = $('#notes-list');
                if(state.notes.length === 0) { list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">No notes.</div>`; return; }
                list.innerHTML = state.notes.map(n => `<div class="card p-6 flex flex-col" data-note-id="${n.id}"><div class="flex-grow"><h3 class="font-bold text-lg mb-2">${n.title}</h3><p class="text-gray-600 dark:text-gray-300 text-sm whitespace-pre-wrap">${n.content || ''}</p>${n.dueDate ? `<div class="mt-2 text-xs text-yellow-600">üîî Reminder: ${new Date(n.dueDate).toLocaleDateString()}</div>` : ''}</div><div class="mt-4 pt-4 border-t flex justify-end gap-2"><button class="note-edit-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button><button class="note-delete-btn p-2 hover:bg-gray-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button></div></div>`).join('');
            }

            function renderKanbanView(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) { state.activeView = 'projects'; render(); return; }
                $('#kanban-project-title').textContent = project.name;
                const projectTasks = state.tasks.filter(t => t.projectId === projectId);
                const cols = { pending: $('#kanban-pending'), progress: $('#kanban-progress'), done: $('#kanban-done') };
                Object.values(cols).forEach(c => c.innerHTML = '');
                projectTasks.forEach(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    cols[task.status || 'pending'].innerHTML += `<div class="kanban-task card p-3" draggable="true" data-task-id="${task.id}"><h4 class="font-bold mb-1">${task.title}</h4><div class="flex justify-between items-center"><span class="${priorityInfo.badge} text-[10px] px-2 py-0.5 rounded-full">${priorityInfo.text}</span></div></div>`;
                });
                if (window.lucide) lucide.createIcons();
                setupKanbanEventListeners(projectId);
            }

            function updateCalendarViewToggle() {
                const monthBtn = $('#calendar-view-month'), weekBtn = $('#calendar-view-week');
                monthBtn.classList.remove('bg-black/20'), weekBtn.classList.remove('bg-black/20');
                if (state.calendarView === 'month') monthBtn.classList.add('bg-black/20');
                else weekBtn.classList.add('bg-black/20');
            }

            function renderMonthlyCalendar() {
                const calContainer = $('#calendar-container'), calTitle = $('#calendar-title'), date = state.calendarDate;
                calTitle.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const month = date.getMonth(), year = date.getFullYear(), firstDay = new Date(year, month, 1).getDay(), days = new Date(year, month + 1, 0).getDate(), allEvents = getAllCalendarEvents();
                let gridHtml = '<div class="calendar-grid">' + 'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').map(d => `<div class="calendar-header">${d}</div>`).join('');
                for (let i = 0; i < firstDay; i++) gridHtml += '<div class="calendar-day other-month"></div>';
                for (let i = 1; i <= days; i++) {
                    const dayDate = new Date(year, month, i).setHours(0,0,0,0);
                    const events = allEvents.filter(e => new Date(e.dueDate).setHours(0,0,0,0) === dayDate);
                    gridHtml += `<div class="calendar-day"><div class="font-bold text-right">${i}</div>${events.map(e => `<div class="${e.type === 'task' ? 'calendar-task' : 'calendar-note'} text-[10px] p-1 my-0.5 rounded truncate">${e.title}</div>`).join('')}</div>`;
                }
                calContainer.innerHTML = gridHtml + '</div>';
            }

            function renderWeeklyCalendar() {
                const calContainer = $('#calendar-container'), calTitle = $('#calendar-title'), date = new Date(state.calendarDate);
                const first = new Date(date.setDate(date.getDate() - date.getDay())), last = new Date(new Date(first).setDate(first.getDate() + 6));
                calTitle.textContent = `${first.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${last.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                const allEvents = getAllCalendarEvents();
                let gridHtml = '<div class="calendar-grid">' + 'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').map(d => `<div class="calendar-header">${d}</div>`).join('');
                for (let i = 0; i < 7; i++) {
                    const curr = new Date(first); curr.setDate(first.getDate() + i); curr.setHours(0,0,0,0);
                    const events = allEvents.filter(e => new Date(e.dueDate).setHours(0,0,0,0) === curr.getTime());
                    gridHtml += `<div class="calendar-day"><div class="font-bold text-right">${curr.getDate()}</div>${events.map(e => `<div class="${e.type === 'task' ? 'calendar-task' : 'calendar-note'} text-[10px] p-1 my-0.5 rounded truncate">${e.title}</div>`).join('')}</div>`;
                }
                calContainer.innerHTML = gridHtml + '</div>';
            }

            function renderCalendar() {
                updateCalendarViewToggle();
                if (state.calendarView === 'month') renderMonthlyCalendar();
                else renderWeeklyCalendar();
                const today = new Date().setHours(0,0,0,0), all = getAllCalendarEvents(), todays = all.filter(e => new Date(e.dueDate).setHours(0,0,0,0) === today);
                $('#calendar-today-tasks').innerHTML = todays.length ? todays.map(e => `<div class="p-2 rounded ${e.type === 'task' ? 'bg-blue-100' : 'bg-yellow-100'}">${e.title}</div>`).join('<div class="my-1"></div>') : '<p class="text-gray-400">Nothing today.</p>';
            }
            
            function openModal(title, content, setup) {
                $('#modal-title').textContent = title; $('#modal-body').innerHTML = content;
                const container = $('#modal-container');
                container.classList.remove('hidden'); container.classList.add('flex');
                setTimeout(() => { container.classList.remove('opacity-0'); $('#modal-content').classList.remove('-translate-y-10'); }, 10);
                if (window.lucide) lucide.createIcons();
                if (setup) setup();
            }

            function closeModal() {
                $('#modal-content').classList.add('-translate-y-10');
                $('#modal-container').classList.add('opacity-0');
                setTimeout(() => { const c = $('#modal-container'); c.classList.add('hidden'); c.classList.remove('flex'); $('#modal-body').innerHTML = ''; }, 300);
            }
            
            function showConfirmationModal(title, message, onConfirm) {
                const content = `<p class="mb-6">${message}</p><div class="flex justify-end gap-4"><button id="modal-cancel-confirm" class="btn btn-cancel">Cancel</button><button id="modal-confirm" class="btn bg-red-500 text-white">Confirm</button></div>`;
                openModal(title, content, () => { $('#modal-confirm').onclick = () => { onConfirm(); closeModal(); }; $('#modal-cancel-confirm').onclick = () => closeModal(); });
            }

            function getTaskFormHtml(task = {}) {
                const projects = state.projects.map(p => `<option value="${p.id}" ${task.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                return `<form id="task-form" class="space-y-4" data-task-id="${task.id || ''}"><div><label class="block mb-1 font-bold">Title</label><input name="title" required class="w-full p-2" value="${task.title || ''}"></div><div><label class="block mb-1">Description</label><textarea name="description" class="w-full p-2">${task.description || ''}</textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block mb-1">Date</label><input name="dueDate" type="date" class="w-full p-2" value="${task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : ''}"></div><div><label class="block mb-1">Project</label><select name="projectId" class="w-full p-2"><option value="">None</option>${projects}</select></div></div><div><label class="block mb-1">Priority</label><select name="priority" class="w-full p-2"><option value="p1" ${task.priority==='p1'?'selected':''}>üî• Highest</option><option value="p2" ${task.priority==='p2'?'selected':''}>‚ö†Ô∏è High</option><option value="p3" ${!task.priority||task.priority==='p3'?'selected':''}>üîµ Medium</option><option value="p4" ${task.priority==='p4'?'selected':''}>‚¨áÔ∏è Low</option></select></div><div><label class="block mb-1">Tags</label><input name="tags" class="w-full p-2" value="${(task.tags||[]).join(', ')}"></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form>`;
            }

            function getProjectFormHtml(project = {}) {
                return `<form id="project-form" class="space-y-4" data-project-id="${project.id || ''}"><div><label class="block mb-1">Name</label><input name="name" required class="w-full p-2" value="${project.name || ''}"></div><div><label class="block mb-1">Description</label><textarea name="description" class="w-full p-2">${project.description || ''}</textarea></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form>`;
            }

            function getNoteFormHtml(note = {}) {
                return `<form id="note-form" class="space-y-4" data-note-id="${note.id || ''}"><div><label class="block mb-1">Title</label><input name="title" required class="w-full p-2" value="${note.title || ''}"></div><div><label class="block mb-1">Content</label><textarea name="content" class="w-full p-2" rows="6">${note.content || ''}</textarea></div><div><label class="block mb-1">Reminder</label><input name="dueDate" type="date" class="w-full p-2" value="${note.dueDate ? new Date(note.dueDate).toISOString().split('T')[0] : ''}"></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="modal-cancel" class="btn btn-cancel">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form>`;
            }
            
            async function handleFormSubmit(e) {
                e.preventDefault(); const form = e.target, formData = new FormData(form);
                let item, store;
                if (form.id === 'task-form') {
                    store = 'tasks'; const id = form.dataset.taskId, existing = state.tasks.find(t => t.id === id) || {};
                    item = { ...existing, id: id || `t${Date.now()}`, createdAt: existing.createdAt || Date.now(), completed: existing.completed || false, completedAt: existing.completedAt || null, status: existing.status || 'pending', title: formData.get('title'), description: formData.get('description'), dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null, projectId: formData.get('projectId'), priority: formData.get('priority'), tags: (formData.get('tags')||'').split(',').map(t=>t.trim()).filter(t=>t) };
                } else if (form.id === 'project-form') {
                    store = 'projects'; const id = form.dataset.projectId, existing = state.projects.find(p => p.id === id) || {};
                    item = { ...existing, id: id || `p${Date.now()}`, createdAt: existing.createdAt || Date.now(), name: formData.get('name'), description: formData.get('description') };
                } else if (form.id === 'note-form') {
                    store = 'notes'; const id = form.dataset.noteId, existing = state.notes.find(n => n.id === id) || {};
                    item = { ...existing, id: id || `n${Date.now()}`, createdAt: existing.createdAt || Date.now(), title: formData.get('title'), content: formData.get('content'), dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null };
                }
                if (item && store) { await dbService.add(store, item); await refreshState(); render(); closeModal(); }
            }
            
            function setupFormEventListeners() { const form = $('#modal-body form'); if (form) form.addEventListener('submit', handleFormSubmit); }

            function handleNavClick(e) {
                const navItem = e.target.closest('.nav-item'); if (!navItem) return;
                const iframe = $('#content-iframe'); if (iframe) iframe.src = 'about:blank';
                const view = navItem.dataset.view, url = navItem.dataset.iframeUrl;
                if (url) { iframe.src = url; $('#iframe-title').textContent = navItem.dataset.iframeTitle; }
                state.activeView = view; state.activeProjectId = null;
                $$('.nav-item').forEach(el => el.classList.remove('active')); navItem.classList.add('active');
                render();
            }

            async function handleTaskActions(e) {
                const card = e.target.closest('[data-task-id]'); if (!card) return;
                const id = card.dataset.taskId;
                if (e.target.closest('.task-complete-btn')) {
                    const t = state.tasks.find(t => t.id === id);
                    if(t) { t.completed = !t.completed; t.completedAt = t.completed ? Date.now() : null; t.status = t.completed ? 'done' : 'pending'; await dbService.add('tasks', t); await refreshState(); if (state.activeProjectId) renderKanbanView(state.activeProjectId); else render(); }
                } else if (e.target.closest('.task-edit-btn')) {
                    const t = state.tasks.find(t => t.id === id); if (t) openModal('Edit Task', getTaskFormHtml(t), setupFormEventListeners);
                } else if (e.target.closest('.task-delete-btn')) {
                    showConfirmationModal('Delete Task', 'Confirm deletion?', async () => { await dbService.delete('tasks', id); await refreshState(); render(); });
                }
            }
            
            async function handleProjectActions(e) {
                const card = e.target.closest('[data-project-id]'); if (!card) return;
                const id = card.dataset.projectId;
                if (e.target.closest('.project-kanban-btn')) { state.activeView = 'kanban-view'; state.activeProjectId = id; render(); }
                else if (e.target.closest('.project-edit-btn')) { const p = state.projects.find(p => p.id === id); if (p) openModal('Edit Project', getProjectFormHtml(p), setupFormEventListeners); }
                else if (e.target.closest('.project-delete-btn')) { showConfirmationModal('Delete Project', 'Confirm?', async () => { state.tasks.filter(t => t.projectId === id).forEach(async t => { t.projectId = ''; await dbService.add('tasks', t); }); await dbService.delete('projects', id); await refreshState(); render(); }); }
            }

            async function handleNoteActions(e) {
                const card = e.target.closest('[data-note-id]'); if (!card) return;
                const id = card.dataset.noteId;
                if (e.target.closest('.note-edit-btn')) { const n = state.notes.find(n => n.id === id); if (n) openModal('Edit Note', getNoteFormHtml(n), setupFormEventListeners); }
                else if (e.target.closest('.note-delete-btn')) { showConfirmationModal('Delete Note', 'Confirm?', async () => { await dbService.delete('notes', id); await refreshState(); render(); }); }
            }
            
             function openSettingsModal() {
                openModal('Customization', `<div class="space-y-4"><div><label class="block">Primary</label><input type="color" id="primary-color-picker" value="${state.primaryColor}"></div><div><label class="block">Secondary</label><input type="color" id="secondary-color-picker" value="${state.secondaryColor}"></div><div class="flex justify-end pt-4"><button id="save-settings-btn" class="btn btn-primary">Save</button></div></div>`, () => {
                    $('#save-settings-btn').onclick = () => { const p = $('#primary-color-picker').value, s = $('#secondary-color-picker').value; applyColors(p, s); saveColorsToStorage(p, s); closeModal(); };
                });
            }

            function setupKanbanEventListeners(projectId) {
                const tasks = $$('#kanban-view .kanban-task');
                tasks.forEach(t => { t.ondragstart = (e) => { t.classList.add('dragging'); e.dataTransfer.setData('text/plain', t.dataset.taskId); }; t.ondragend = () => t.classList.remove('dragging'); });
                $$('#kanban-view .kanban-tasks-container').forEach(col => {
                    col.ondragover = e => { e.preventDefault(); col.parentElement.classList.add('drag-over'); };
                    col.ondragleave = () => col.parentElement.classList.remove('drag-over');
                    col.ondrop = async e => {
                        e.preventDefault(); col.parentElement.classList.remove('drag-over');
                        const id = e.dataTransfer.getData('text/plain'), task = state.tasks.find(t => t.id === id);
                        if (!task) return;
                        const status = col.id.replace('kanban-', '');
                        if (task.status !== status) { task.status = status; task.completed = (status === 'done'); task.completedAt = task.completed ? Date.now() : null; await dbService.add('tasks', task); await refreshState(); renderKanbanView(projectId); }
                    };
                });
            }

            function setupEventListeners() {
                $('.sidebar nav').onclick = handleNavClick;
                $('#tasks-list').onclick = handleTaskActions;
                $('#projects-list').onclick = handleProjectActions;
                $('#notes-list').onclick = handleNoteActions;
                $('#back-to-projects-btn').onclick = () => { state.activeView = 'projects'; render(); };
                $('#tasks').oninput = e => { if (e.target.id === 'task-search-input') { state.taskSearchQuery = e.target.value; renderTasks(); } };
                $('#settings-btn').onclick = openSettingsModal;
                $('#theme-toggle').onclick = () => { const dark = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', dark ? 'dark' : 'light'); $('#theme-toggle').innerHTML = `<i data-lucide="${dark ? 'moon' : 'sun'}"></i><span>${dark ? 'Dark' : 'Light'}</span>`; lucide.createIcons(); render(); };
                
                // Fixed Modal Event Listener
                $('#modal-container').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-container' || e.target.closest('#modal-close') || e.target.id === 'modal-cancel') {
                        closeModal();
                    }
                });
                
                $('#btn-add-task').onclick = () => openModal('Add Task', getTaskFormHtml(), setupFormEventListeners);
                $('#add-task-from-view').onclick = () => openModal('Add Task', getTaskFormHtml(), setupFormEventListeners);
                $('#btn-add-project').onclick = () => openModal('Add Project', getProjectFormHtml(), setupFormEventListeners);
                $('#add-project-from-view').onclick = () => openModal('Add Project', getProjectFormHtml(), setupFormEventListeners);
                $('#btn-add-note').onclick = () => openModal('Add Note', getNoteFormHtml(), setupFormEventListeners);
                $('#add-note-from-view').onclick = () => openModal('Add Note', getNoteFormHtml(), setupFormEventListeners);

                $('#calendar-prev').onclick = () => { if (state.calendarView === 'month') state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); else state.calendarDate.setDate(state.calendarDate.getDate() - 7); renderCalendar(); };
                $('#calendar-next').onclick = () => { if (state.calendarView === 'month') state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); else state.calendarDate.setDate(state.calendarDate.getDate() + 7); renderCalendar(); };
                $('#calendar-view-month').onclick = () => { state.calendarView = 'month'; renderCalendar(); };
                $('#calendar-view-week').onclick = () => { state.calendarView = 'week'; renderCalendar(); };
                $('#download-ics-btn').onclick = downloadICS;
                $('#sync-google-btn').onclick = () => {
                    const ts = state.tasks.filter(t => t.dueDate);
                    openModal('Sync Google', ts.length ? ts.map(t => `<div class="p-3 border-b flex justify-between"><span>${t.title}</span><button class="btn btn-primary text-xs" onclick="window.open('https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t.title)}&dates=${new Date(t.dueDate).toISOString().replace(/-|:|\.\\d{3}/g, '').split('T')[0]}/${new Date(t.dueDate).toISOString().replace(/-|:|\.\\d{3}/g, '').split('T')[0]}', '_blank')">Sync</button></div>`).join('') : 'No tasks.', null);
                };
            }

            function downloadICS() {
                let ics = "BEGIN:VCALENDAR\nVERSION:2.0\n";
                getAllCalendarEvents().forEach(e => { if (e.dueDate) { const d = new Date(e.dueDate).toISOString().replace(/-|:|\.\d{3}/g, "").substring(0,8); ics += `BEGIN:VEVENT\nSUMMARY:${e.title}\nDTSTART;VALUE=DATE:${d}\nDTEND;VALUE=DATE:${d}\nEND:VEVENT\n`; } });
                ics += "END:VCALENDAR";
                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([ics], {type: "text/calendar"})); link.download = "calendar.ics"; link.click();
            }
            
            async function refreshState() { [state.tasks, state.projects, state.notes] = await Promise.all([dbService.getAll('tasks'), dbService.getAll('projects'), dbService.getAll('notes')]); }

            async function init() { loadColorsFromStorage(); if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); setupEventListeners(); activityTracker.init(); await dbService.init(); await refreshState(); render(); }
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>
